"use strict";chill_penguin.module("form.autocomplete",(()=>{let e,t={};return{i18n:{notify:{en:"As you start typing the application might suggest similar search terms. Use tab, up, or down arrow keys to select a suggested search string. Use Enter key to confirm that value. Use ESC key to exit the results and return focus to the input.","en-CA":"As you start typing the application might suggest similar search terms. Use tab, up, or down arrow keys to select a suggested search string. Use Enter key to confirm that value. Use ESC key to exit the results and return focus to the input.",fr:""}},initialize:()=>{e=chill_penguin.form.autocomplete,t={},e.setup()},ready:()=>{document.querySelectorAll("[data-module='autocomplete']").forEach((async t=>{let a=t.getAttribute("id");"function"===t.getAttribute("data-autocomplete-source-type")&&await e.data.initialize(a)}))},setup:()=>{document.querySelectorAll("[data-module='autocomplete']").forEach((async a=>{let l=a.getAttribute("id"),i=a.getAttribute("data-autocomplete-source-type");t[l]={el:a,input:a.querySelector("[data-module='autocomplete.input']"),input_format:JSON.parse(a.getAttribute("data-autocomplete-input-format")),input_values:a.getAttribute("data-autocomplete-values")?JSON.parse(a.getAttribute("data-autocomplete-values")):null,value_format:JSON.parse(a.getAttribute("data-autocomplete-value-format"))?JSON.parse(a.getAttribute("data-autocomplete-value-format")):JSON.parse(`["${a.getAttribute("data-autocomplete-filter")}"]`),filter:a.getAttribute("data-autocomplete-filter"),type:a.getAttribute("data-autocomplete-type"),data_source_type:i,data_source:a.getAttribute("data-autocomplete-source"),data_raw:"",data_working:"",results:a.querySelector("[data-module='autocomplete.results']"),max_num_results:parseInt(a.querySelector("[data-module='autocomplete.results']").getAttribute("data-autocomplete-max-results")),sr_description:a.querySelector("[data-module='autocomplete.sr-description']"),error_message:a.querySelector("[data-module='autocomplete.error']")||!1,multiselect:a.querySelector("[data-module='autocomplete.multiselect']")||!1,multiselect_tags_container:a.querySelector("[data-module='autocomplete.multiselect-tags']")||!1,multiselect_tags_limit:parseInt(a.getAttribute("data-autocomplete-multiselect-tags-limit"),10)||1/0,onupdate:a.getAttribute("data-autocomplete-onupdate-func")||!1,onpreview:a.getAttribute("data-autocomplete-preview-func")||!1,preview_value:a.getAttribute("data-autocomplete-preview-value")?JSON.parse(a.getAttribute("data-autocomplete-preview-value")):null},"fetch"!==i&&"file"!==i||await e.data.initialize(l),e.ui.create_default_tags(l),e.event_listeners.initialize(l)}))},data:{initialize:async e=>{try{const{input_values:a,value_format:l,data_source_type:i,data_source:o}=t[e];let s;"fetch"===i?s=await chill_penguin.util.fetch(o):"function"===i?s=await chill_penguin.util.run_str_func(o):"file"===i&&(s=o),s&&(t[e].data_raw=s,t[e].data_working=s.map((e=>({...e,status:""}))),a&&a.length>0&&t[e].data_working.forEach((e=>{a.includes(e[l])&&(e.status="selected")})))}catch(e){console.error("Failed to initialize data:",e)}},update_input_value:(e,a)=>{const{el:l,type:i,onupdate:o}=t[e];t[e].input_values=a,l.setAttribute("data-autocomplete-values",JSON.stringify(a)),o&&chill_penguin.util.run_str_func(o,{id:e})}},a11y:{update_sr_description:(a,l)=>{const{sr_description:i}=t[a];i.innerHTML=""===l?e.i18n.notify[LANG]:l}},event_listeners:{keys_to_ignore:[keyboard.keys.tab,keyboard.keys.esc,keyboard.keys.down,keyboard.keys.up,keyboard.keys.enter,keyboard.keys.shift],initialize:a=>{const{results:l,input:i,max_num_results:o,error_message:s}=t[a];i.removeEventListener("keydown",e.event_listeners.input.keydown_navigate_dropdown),i.addEventListener("keydown",e.event_listeners.input.keydown_navigate_dropdown),i.removeEventListener("keydown",e.event_listeners.input.keydown_search_string),i.addEventListener("keydown",e.event_listeners.input.keydown_search_string),i.removeEventListener("keyup",e.event_listeners.input.clear_input),i.addEventListener("keyup",e.event_listeners.input.clear_input),i.removeEventListener("focus",e.event_listeners.input.focus),i.addEventListener("focus",e.event_listeners.input.focus)},input:{keydown_navigate_dropdown:a=>{const l=chill_penguin.util.closest_parent(a.currentTarget,'[data-module="autocomplete"]').getAttribute("id"),{el:i,results:o,input:s,onpreview:u}=t[l];let r=o.querySelector(".selected");const n=r&&r.getAttribute("data-sr-description");switch(i.setAttribute("data-autocomplete-last-removed",n),a.keyCode){case keyboard.keys.down:if(r?(r.classList.remove("selected"),r===o.querySelector("li:last-child")?o.querySelector("li:nth-child(1)").classList.add("selected"):r.nextElementSibling.classList.add("selected")):o.querySelector("li:nth-child(1)")&&o.querySelector("li:nth-child(1)").classList.add("selected"),o.querySelector(".selected")){const t=o.querySelector(".selected").getAttribute("data-sr-description");i.setAttribute("data-autocomplete-last-added",t),e.a11y.update_sr_description(l,t),i.setAttribute("data-autocomplete-preview-value",`["${t}"]`),s.setAttribute("aria-activedescendant",o.querySelector(".selected").getAttribute("id")),u&&chill_penguin.util.run_str_func(u,{id:l})}break;case keyboard.keys.up:if(r){r.classList.remove("selected"),r===o.querySelector("li:nth-child(1)")?o.querySelector("li:last-child").classList.add("selected"):r.previousElementSibling.classList.add("selected");const t=o.querySelector(".selected").getAttribute("data-sr-description");i.setAttribute("data-autocomplete-last-added",t),e.a11y.update_sr_description(l,t),i.setAttribute("data-autocomplete-preview-value",`["${t}"]`),s.setAttribute("aria-activedescendant",o.querySelector(".selected").getAttribute("id")),u&&chill_penguin.util.run_str_func(u,{id:l})}break;case keyboard.keys.esc:case keyboard.keys.tab:e.action.close(l,!0);break;case keyboard.keys.enter:a.preventDefault(),r&&r.click()}},keydown_search_string:t=>{chill_penguin.debounce(e.event_listeners.input.keydown_search_string_debounced,250)(t)},keydown_search_string_debounced:t=>{const a=chill_penguin.util.closest_parent(t.target,'[data-module="autocomplete"]').getAttribute("id");e.event_listeners.keys_to_ignore.includes(t.keyCode)||e.action.execute_search(a)},clear_input:a=>{const l=chill_penguin.util.closest_parent(a.currentTarget,'[data-module="autocomplete"]').getAttribute("id"),{type:i}=t[l];switch(a.keyCode){case keyboard.keys.backspace:case keyboard.keys.delete:""===a.currentTarget.value&&("single-select"===i&&e.data.update_input_value(l,[]),e.action.close(l,!0))}},focus:a=>{const l=chill_penguin.util.closest_parent(a.target,'[data-module="autocomplete"]').getAttribute("id"),{error_message:i}=t[l];e.a11y.update_sr_description(l,a.target.value),document.getElementById(l).classList.add("active"),document.getElementById(l).setAttribute("aria-expanded","true"),i.classList.remove("has-error")}},outside_dropdown:{click:{close:()=>{"autocomplete.results-item"!==event.target.getAttribute("data-module")&&"autocomplete.tag.button"!==event.target.getAttribute("data-module")&&setTimeout((()=>{e.action.close()}),250)}}}},action:{execute_search:a=>{const{input:l}=t[a];l.value.trim().length>0&&e.ui.show_autocomplete_list(a)},close:()=>{document.removeEventListener("click",e.event_listeners.outside_dropdown.click.close),document.querySelectorAll("[data-module='autocomplete']").forEach((e=>{e.classList.remove("active"),e.setAttribute("aria-expanded","false"),e.querySelector("[data-module='autocomplete.results']").classList.add("display:none"),e.querySelector("[data-module='autocomplete.results']").innerHTML=""}))}},ui:{create_default_tags:a=>{const{data_working:l,input_format:i,multiselect_tags_container:o}=t[a];l&&o&&l.forEach(((t,l)=>{if("selected"===t.status){const s=e.util.modify_format(i,t);let u=e.util.create_tag_html(a,l,s);o.innerHTML+=u}}))},show_autocomplete_list:a=>{const{type:l,input:i,filter:o,data_working:s,results:u,max_num_results:r,multiselect_tags_limit:n}=t[a],c=i.value.trim();let d;if(s.length>0){u.innerHTML="";let t=0;if(s.filter((e=>"selected"===e.status)).length<n)for(let l=0;l<s.length&&(d=s[l][o].toLowerCase(),""!==s[l].status||""===s[l][o]||"*"!==c&&!d.includes(c.toLowerCase())||(t++,document.removeEventListener("click",e.event_listeners.outside_dropdown.click.close),document.addEventListener("click",e.event_listeners.outside_dropdown.click.close),u.insertAdjacentHTML("beforeend",e.ui.render_autocomplete_result(a,l,s[l])),u.classList.remove("display:none"),document.getElementById(a).classList.add("active"),document.getElementById(a).setAttribute("aria-expanded","true"),t!==r));l++);else u.classList.add("display:none")}},render_autocomplete_result:(a,l,i)=>{const{type:o,input:s,input_format:u,max_num_results:r}=t[a],n=e.util.modify_format(u,i),c=s.getAttribute("id");return"single-select"===o?`\n        <li role="option" data-module="autocomplete.results-item" id="autocomplete-suggestion-${l}" class="unstyle w:100% display:flex align:middle" data-sr-description="${n}" onclick="chill_penguin.form.autocomplete.ui.autocomplete_fill('${a}', ${l}, '${n}');chill_penguin.form.autocomplete.action.close();">${chill_penguin.util.encode_html_entities(n)}</li>`:"multiselect"===o?`\n        <li role='option' data-module="autocomplete.results-item" id='autocomplete-suggestion-${l}' class='unstyle w:100% display:flex align:middle' data-sr-description='${n}' onclick='chill_penguin.form.autocomplete.ui.autocomplete_fill("${a}", ${l}, "${n}");document.getElementById("${c}").focus();'>${chill_penguin.util.encode_html_entities(n)}</li>`:void 0},autocomplete_fill:(a,l,i)=>{const{el:o,value_format:s,type:u,input:r,max_num_results:n,results:c,data_working:d,onupdate:p}=t[a];r.getAttribute("id"),r.value.trim();if("single-select"===u)c.innerHTML="",r.value=i,e.data.update_input_value(a,[e.util.modify_format(s,d[l])]);else if("multiselect"===u){const{multiselect_tags_container:u}=t[a];d[l].status="selected",r.value="",e.ui.show_autocomplete_list(a),u.innerHTML+=e.util.create_tag_html(a,l,i);const n=t[a].input_values||[],c=e.util.modify_format(s,d[l]);n.includes(c)||n.push(c),o.removeAttribute("data-autocomplete-last-removed"),o.setAttribute("data-autocomplete-last-added",c),e.data.update_input_value(a,n)}},remove_selected:(a,l)=>{const{el:i,value_format:o,input:s,max_num_results:u,results:r,data_working:n}=t[a];document.getElementById(a).querySelector(`[data-autocomplete-tag="${l}"]`).remove(),n[l].status="";const c=t[a].input_values||[],d=e.util.modify_format(o,n[l]),p=c.filter((e=>e!==d));i.removeAttribute("data-autocomplete-last-added"),i.setAttribute("data-autocomplete-last-removed",d),e.data.update_input_value(a,p)}},util:{modify_format:(e,t)=>e.reduce(((e,a)=>a in t?e+(t[a]?t[a]:a):e+a),"").trim(),create_tag_html:(e,t,a)=>`<div class='heebo:bold py:2px px:8px brr:4px mr:4px my:2px b-silver:1px display:flex align:middle' data-autocomplete-tag='${t}'>${chill_penguin.util.encode_html_entities(a)} <button data-module='autocomplete.tag.button' class='heebo:bold fs:20px color:white pl:4px lh:0' onclick='chill_penguin.form.autocomplete.ui.remove_selected("${e}", ${t});'>&times;</button></div>`}}}));